"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[408],{27004:function(e,t,r){var s=this&&this.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r);var i=Object.getOwnPropertyDescriptor(t,r);(!i||("get"in i?!t.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,s,i)}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&s(t,e,r);return i(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.useMicVAD=t.defaultReactRealTimeVADOptions=t.utils=void 0;let o=r(39762),n=a(r(67294));var c=r(39762);Object.defineProperty(t,"utils",{enumerable:!0,get:function(){return c.utils}});let l={startOnLoad:!0,userSpeakingThreshold:.6};t.defaultReactRealTimeVADOptions={...o.defaultRealTimeVADOptions,...l};let u=Object.keys(l),d=Object.keys(o.defaultRealTimeVADOptions),_filter=(e,t)=>e.reduce((e,r)=>(e[r]=t[r],e),{});function useEventCallback(e){let t=n.default.useRef(e);return h(()=>{t.current=e}),n.default.useCallback((...e)=>t.current.apply(void 0,e),[])}t.useMicVAD=function(e){let[r,s]=function(e){e={...t.defaultReactRealTimeVADOptions,...e};let r=_filter(u,e),s=_filter(d,e);return[r,s]}(e),[i,a]=(0,n.useReducer)((e,t)=>t>r.userSpeakingThreshold,!1),[c,l]=(0,n.useState)(!0),[h,p]=(0,n.useState)(!1),[f,m]=(0,n.useState)(!1),[g,v]=(0,n.useState)(null);useEventCallback(s.onFrameProcessed),s.onFrameProcessed=useEventCallback(e=>{a(e.isSpeech)});let{onSpeechEnd:w,onSpeechStart:S,onVADMisfire:b}=s,_=useEventCallback(w),y=useEventCallback(S),A=useEventCallback(b);s.onSpeechEnd=_,s.onSpeechStart=y,s.onVADMisfire=A,(0,n.useEffect)(()=>{let setup=async()=>{let e;try{e=await o.MicVAD.new(s)}catch(e){l(!1),e instanceof Error?p({message:e.message}):p({message:e});return}v(e),l(!1),r.startOnLoad&&(e?.start(),m(!0))};return setup().catch(e=>{console.log("Well that didn't work")}),function(){c||h||(g?.pause(),m(!1))}},[]);let pause=()=>{c||h||(g?.pause(),m(!1))},start=()=>{c||h||(g?.start(),m(!0))};return{listening:f,errored:h,loading:c,userSpeaking:i,pause,start,toggle:()=>{f?pause():start()}}};let h="undefined"!=typeof window&&void 0!==window.document&&void 0!==window.document.createElement?n.default.useLayoutEffect:n.default.useEffect},92527:function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0}),t.FrameProcessor=t.validateOptions=t.defaultFrameProcessorOptions=void 0;let s=r(65531),i=r(58655),a=[512,1024,1536];t.defaultFrameProcessorOptions={positiveSpeechThreshold:.5,negativeSpeechThreshold:.35,preSpeechPadFrames:1,redemptionFrames:8,frameSamples:1536,minSpeechFrames:3},t.validateOptions=function(e){a.includes(e.frameSamples)||i.log.warn("You are using an unusual frame size"),(e.positiveSpeechThreshold<0||e.negativeSpeechThreshold>1)&&i.log.error("postiveSpeechThreshold should be a number between 0 and 1"),(e.negativeSpeechThreshold<0||e.negativeSpeechThreshold>e.positiveSpeechThreshold)&&i.log.error("negativeSpeechThreshold should be between 0 and postiveSpeechThreshold"),e.preSpeechPadFrames<0&&i.log.error("preSpeechPadFrames should be positive"),e.redemptionFrames<0&&i.log.error("preSpeechPadFrames should be positive")};let concatArrays=e=>{let t=e.reduce((e,t)=>(e.push(e.at(-1)+t.length),e),[0]),r=new Float32Array(t.at(-1));return e.forEach((e,s)=>{let i=t[s];r.set(e,i)}),r};t.FrameProcessor=class{constructor(e,t,r){this.modelProcessFunc=e,this.modelResetFunc=t,this.options=r,this.speaking=!1,this.redemptionCounter=0,this.active=!1,this.reset=()=>{this.speaking=!1,this.audioBuffer=[],this.modelResetFunc(),this.redemptionCounter=0},this.pause=()=>{this.active=!1,this.reset()},this.resume=()=>{this.active=!0},this.endSegment=()=>{let e=this.audioBuffer;this.audioBuffer=[];let t=this.speaking;this.reset();let r=e.reduce((e,t)=>e+ +t.isSpeech,0);if(t){if(!(r>=this.options.minSpeechFrames))return{msg:s.Message.VADMisfire};{let t=concatArrays(e.map(e=>e.frame));return{msg:s.Message.SpeechEnd,audio:t}}}return{}},this.process=async e=>{if(!this.active)return{};let t=await this.modelProcessFunc(e);if(this.audioBuffer.push({frame:e,isSpeech:t.isSpeech>=this.options.positiveSpeechThreshold}),t.isSpeech>=this.options.positiveSpeechThreshold&&this.redemptionCounter&&(this.redemptionCounter=0),t.isSpeech>=this.options.positiveSpeechThreshold&&!this.speaking)return this.speaking=!0,{probs:t,msg:s.Message.SpeechStart};if(t.isSpeech<this.options.negativeSpeechThreshold&&this.speaking&&++this.redemptionCounter>=this.options.redemptionFrames){this.redemptionCounter=0,this.speaking=!1;let e=this.audioBuffer;this.audioBuffer=[];let r=e.reduce((e,t)=>e+ +t.isSpeech,0);if(!(r>=this.options.minSpeechFrames))return{probs:t,msg:s.Message.VADMisfire};{let r=concatArrays(e.map(e=>e.frame));return{probs:t,msg:s.Message.SpeechEnd,audio:r}}}if(!this.speaking)for(;this.audioBuffer.length>this.options.preSpeechPadFrames;)this.audioBuffer.shift();return{probs:t}},this.audioBuffer=[],this.reset()}}},91978:function(e,t,r){var s=this&&this.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r);var i=Object.getOwnPropertyDescriptor(t,r);(!i||("get"in i?!t.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,s,i)}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&s(t,e,r);return i(t,e),t},o=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||s(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),t.utils=void 0;let n=a(r(15818));t.utils={minFramesForTargetMS:n.minFramesForTargetMS,arrayBufferToBase64:n.arrayBufferToBase64,encodeWAV:n.encodeWAV},o(r(34684),t),o(r(92527),t),o(r(65531),t),o(r(58655),t),o(r(92002),t),o(r(48533),t)},58655:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.log=t.LOG_PREFIX=void 0,t.LOG_PREFIX="[VAD]";let r=["error","debug","warn"].reduce((e,r)=>(e[r]=(...e)=>{console[r](t.LOG_PREFIX,...e)},e),{});t.log=r},65531:function(e,t){var r;Object.defineProperty(t,"__esModule",{value:!0}),t.Message=void 0,(r=t.Message||(t.Message={})).AudioFrame="AUDIO_FRAME",r.SpeechStart="SPEECH_START",r.VADMisfire="VAD_MISFIRE",r.SpeechEnd="SPEECH_END"},92002:function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0}),t.Silero=void 0;let s=r(58655);let Silero=class Silero{constructor(e,t){this.ort=e,this.modelFetcher=t,this.init=async()=>{s.log.debug("initializing vad");let e=await this.modelFetcher();this._session=await this.ort.InferenceSession.create(e),this._sr=new this.ort.Tensor("int64",[16000n]),this.reset_state(),s.log.debug("vad is initialized")},this.reset_state=()=>{let e=Array(128).fill(0);this._h=new this.ort.Tensor("float32",e,[2,1,64]),this._c=new this.ort.Tensor("float32",e,[2,1,64])},this.process=async e=>{let t=new this.ort.Tensor("float32",e,[1,e.length]),r={input:t,h:this._h,c:this._c,sr:this._sr},s=await this._session.run(r);this._h=s.hn,this._c=s.cn;let[i]=s.output.data;return{notSpeech:1-i,isSpeech:i}}}};t.Silero=Silero,Silero.new=async(e,t)=>{let r=new Silero(e,t);return await r.init(),r}},34684:function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0}),t.PlatformAgnosticNonRealTimeVAD=t.defaultNonRealTimeVADOptions=void 0;let s=r(92527),i=r(65531),a=r(92002),o=r(48533);t.defaultNonRealTimeVADOptions={...s.defaultFrameProcessorOptions},t.PlatformAgnosticNonRealTimeVAD=class{static async _new(e,r,s={}){let i=new this(e,r,{...t.defaultNonRealTimeVADOptions,...s});return await i.init(),i}constructor(e,t,r){this.modelFetcher=e,this.ort=t,this.options=r,this.init=async()=>{let e=await a.Silero.new(this.ort,this.modelFetcher);this.frameProcessor=new s.FrameProcessor(e.process,e.reset_state,{frameSamples:this.options.frameSamples,positiveSpeechThreshold:this.options.positiveSpeechThreshold,negativeSpeechThreshold:this.options.negativeSpeechThreshold,redemptionFrames:this.options.redemptionFrames,preSpeechPadFrames:this.options.preSpeechPadFrames,minSpeechFrames:this.options.minSpeechFrames}),this.frameProcessor.resume()},this.run=async function*(e,t){let r,s;let a={nativeSampleRate:t,targetSampleRate:16e3,targetFrameSize:this.options.frameSamples},n=new o.Resampler(a),c=n.process(e);for(let e of[...Array(c.length)].keys()){let t=c[e],{msg:a,audio:o}=await this.frameProcessor.process(t);switch(a){case i.Message.SpeechStart:r=e*this.options.frameSamples/16;break;case i.Message.SpeechEnd:s=(e+1)*this.options.frameSamples/16,yield{audio:o,start:r,end:s}}}let{msg:l,audio:u}=this.frameProcessor.endSegment();l==i.Message.SpeechEnd&&(yield{audio:u,start:r,end:c.length*this.options.frameSamples/16})},(0,s.validateOptions)(r)}}},48533:function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0}),t.Resampler=void 0;let s=r(58655);t.Resampler=class{constructor(e){this.options=e,this.process=e=>{let t=[];for(let t of e)this.inputBuffer.push(t);for(;this.inputBuffer.length*this.options.targetSampleRate/this.options.nativeSampleRate>this.options.targetFrameSize;){let e=new Float32Array(this.options.targetFrameSize),r=0,s=0;for(;r<this.options.targetFrameSize;){let t=0,i=0;for(;s<Math.min(this.inputBuffer.length,(r+1)*this.options.nativeSampleRate/this.options.targetSampleRate);)t+=this.inputBuffer[s],i++,s++;e[r]=t/i,r++}this.inputBuffer=this.inputBuffer.slice(s),t.push(e)}return t},e.nativeSampleRate<16e3&&s.log.error("nativeSampleRate is too low. Should have 16000 = targetSampleRate <= nativeSampleRate"),this.inputBuffer=[]}}},15818:function(e,t){function writeString(e,t,r){for(var s=0;s<r.length;s++)e.setUint8(t+s,r.charCodeAt(s))}Object.defineProperty(t,"__esModule",{value:!0}),t.encodeWAV=t.arrayBufferToBase64=t.minFramesForTargetMS=void 0,t.minFramesForTargetMS=function(e,t,r=16e3){return Math.ceil(e*r/1e3/t)},t.arrayBufferToBase64=function(e){for(var t="",r=new Uint8Array(e),s=r.byteLength,i=0;i<s;i++)t+=String.fromCharCode(r[i]);return btoa(t)},t.encodeWAV=function(e,t=3,r=16e3,s=1,i=32){var a=i/8,o=s*a,n=new ArrayBuffer(44+e.length*a),c=new DataView(n);return writeString(c,0,"RIFF"),c.setUint32(4,36+e.length*a,!0),writeString(c,8,"WAVE"),writeString(c,12,"fmt "),c.setUint32(16,16,!0),c.setUint16(20,t,!0),c.setUint16(22,s,!0),c.setUint32(24,r,!0),c.setUint32(28,r*o,!0),c.setUint16(32,o,!0),c.setUint16(34,i,!0),writeString(c,36,"data"),c.setUint32(40,e.length*a,!0),1===t?function(e,t,r){for(var s=0;s<r.length;s++,t+=2){var i=Math.max(-1,Math.min(1,r[s]));e.setInt16(t,i<0?32768*i:32767*i,!0)}}(c,44,e):function(e,t,r){for(var s=0;s<r.length;s++,t+=4)e.setFloat32(t,r[s],!0)}(c,44,e),n}},77709:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.assetPath=void 0;let r=window.document.currentScript,s="";r&&(s=r.src.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/")),t.assetPath=e=>s+e},39762:function(e,t,r){var s=this&&this.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r);var i=Object.getOwnPropertyDescriptor(t,r);(!i||("get"in i?!t.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,s,i)}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&s(t,e,r);return i(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.defaultRealTimeVADOptions=t.AudioNodeVAD=t.MicVAD=t.NonRealTimeVAD=t.Message=t.FrameProcessor=t.utils=void 0;let o=a(r(18736)),n=r(91978);Object.defineProperty(t,"FrameProcessor",{enumerable:!0,get:function(){return n.FrameProcessor}}),Object.defineProperty(t,"Message",{enumerable:!0,get:function(){return n.Message}});let c=r(96756),l=r(52227);let NonRealTimeVAD=class NonRealTimeVAD extends n.PlatformAgnosticNonRealTimeVAD{static async new(e={}){return await this._new(c.modelFetcher,o,e)}};t.NonRealTimeVAD=NonRealTimeVAD,t.utils={audioFileToArray:l.audioFileToArray,...n.utils};var u=r(17759);Object.defineProperty(t,"MicVAD",{enumerable:!0,get:function(){return u.MicVAD}}),Object.defineProperty(t,"AudioNodeVAD",{enumerable:!0,get:function(){return u.AudioNodeVAD}}),Object.defineProperty(t,"defaultRealTimeVADOptions",{enumerable:!0,get:function(){return u.defaultRealTimeVADOptions}})},96756:function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0}),t.modelFetcher=void 0;let s=r(77709),modelFetcher=async()=>{let e=(0,s.assetPath)("silero_vad.onnx");return await fetch(e).then(e=>e.arrayBuffer())};t.modelFetcher=modelFetcher},17759:function(e,t,r){var s=this&&this.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r);var i=Object.getOwnPropertyDescriptor(t,r);(!i||("get"in i?!t.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,s,i)}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&s(t,e,r);return i(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.AudioNodeVAD=t.MicVAD=t.defaultRealTimeVADOptions=void 0;let o=a(r(18736)),n=r(91978),c=r(96756),l=r(77709);t.defaultRealTimeVADOptions={...n.defaultFrameProcessorOptions,onFrameProcessed:e=>{},onVADMisfire:()=>{n.log.debug("VAD misfire")},onSpeechStart:()=>{n.log.debug("Detected speech start")},onSpeechEnd:()=>{n.log.debug("Detected speech end")},workletURL:(0,l.assetPath)("vad.worklet.bundle.min.js"),stream:void 0};let MicVAD=class MicVAD{static async new(e={}){let r=new MicVAD({...t.defaultRealTimeVADOptions,...e});return await r.init(),r}constructor(e){this.options=e,this.listening=!1,this.init=async()=>{void 0===this.options.stream?this.stream=await navigator.mediaDevices.getUserMedia({audio:{...this.options.additionalAudioConstraints,channelCount:1,echoCancellation:!0,autoGainControl:!0,noiseSuppression:!0}}):this.stream=this.options.stream,this.audioContext=new AudioContext;let e=new MediaStreamAudioSourceNode(this.audioContext,{mediaStream:this.stream});this.audioNodeVAD=await AudioNodeVAD.new(this.audioContext,this.options),this.audioNodeVAD.receive(e)},this.pause=()=>{this.audioNodeVAD.pause(),this.listening=!1},this.start=()=>{this.audioNodeVAD.start(),this.listening=!0},(0,n.validateOptions)(e)}};t.MicVAD=MicVAD;let AudioNodeVAD=class AudioNodeVAD{static async new(e,r={}){let s=new AudioNodeVAD(e,{...t.defaultRealTimeVADOptions,...r});return await s.init(),s}constructor(e,t){this.ctx=e,this.options=t,this.pause=()=>{this.frameProcessor.pause()},this.start=()=>{this.frameProcessor.resume()},this.receive=e=>{e.connect(this.entryNode)},this.processFrame=async e=>{let{probs:t,msg:r,audio:s}=await this.frameProcessor.process(e);switch(void 0!==t&&this.options.onFrameProcessed(t),r){case n.Message.SpeechStart:this.options.onSpeechStart();break;case n.Message.VADMisfire:this.options.onVADMisfire();break;case n.Message.SpeechEnd:this.options.onSpeechEnd(s)}},this.init=async()=>{await this.ctx.audioWorklet.addModule(this.options.workletURL);let e=new AudioWorkletNode(this.ctx,"vad-helper-worklet",{processorOptions:{frameSamples:this.options.frameSamples}});this.entryNode=e;let t=await n.Silero.new(o,c.modelFetcher);this.frameProcessor=new n.FrameProcessor(t.process,t.reset_state,{frameSamples:this.options.frameSamples,positiveSpeechThreshold:this.options.positiveSpeechThreshold,negativeSpeechThreshold:this.options.negativeSpeechThreshold,redemptionFrames:this.options.redemptionFrames,preSpeechPadFrames:this.options.preSpeechPadFrames,minSpeechFrames:this.options.minSpeechFrames}),e.port.onmessage=async e=>{if(e.data?.message===n.Message.AudioFrame){let t=e.data.data,r=new Float32Array(t);await this.processFrame(r)}}},(0,n.validateOptions)(t)}};t.AudioNodeVAD=AudioNodeVAD},52227:function(e,t){async function audioFileToArray(e){let t=new OfflineAudioContext(1,1,44100),r=new FileReader,s=null;if(await new Promise(i=>{r.addEventListener("loadend",e=>{let a=r.result;t.decodeAudioData(a,e=>{s=e,t.startRendering().then(e=>{console.log("Rendering completed successfully"),i()}).catch(e=>{console.error(`Rendering failed: ${e}`)})},e=>{console.log(`Error with decoding audio data: ${e}`)})}),r.readAsArrayBuffer(e)}),null===s)throw Error("some shit");let i=s,a=new Float32Array(i.length);for(let e=0;e<i.length;e++)for(let t=0;t<i.numberOfChannels;t++)a[e]+=i.getChannelData(t)[e];return{audio:a,sampleRate:i.sampleRate}}Object.defineProperty(t,"__esModule",{value:!0}),t.audioFileToArray=void 0,t.audioFileToArray=audioFileToArray},90408:function(e,t,r){r.r(t),r.d(t,{default:function(){return MessageInput}});var s=r(85893),i=r(18736),a=r(67294),o=r(27004),n=r(45417),c=r(24852);function cleanFromPunctuation(e){return e.toLowerCase().replace(/[^\w\s\']|_/g,"").replace(/\s+/g," ")}var l=r(74001),u=r(43826),d=r(65752);async function openaiWhisper(e,t){let r=(0,d.vc)("openai_whisper_apikey");if(!r)throw Error("Invalid OpenAI Whisper API Key");let s=new FormData;s.append("file",e),s.append("model",(0,d.vc)("openai_whisper_model")),s.append("language","en"),t&&s.append("prompt",t),console.debug("whisper-openai req",s);let i=await fetch("".concat((0,d.vc)("openai_whisper_url"),"/v1/audio/transcriptions"),{method:"POST",body:s,headers:{Authorization:"Bearer ".concat(r)}});if(!i.ok)throw Error("OpenAI Whisper API Error (".concat(i.status,")"));let a=await i.json();return console.debug("whisper-openai res",a),{text:a.text.trim()}}async function whispercpp(e,t){let r=new FormData;r.append("file",e),t&&r.append("prompt",t),console.debug("whispercpp req",r);let s=await fetch("".concat((0,d.vc)("whispercpp_url"),"/inference"),{method:"POST",body:r,headers:{Accept:"text/html"}});if(!s.ok)throw Error("Whisper.cpp API Error (".concat(s.status,")"));let i=await s.json();return console.debug("whispercpp res",i),{text:i.text.trim()}}var h=r(60369),p=r(60496);function MessageInput(e){let{userMessage:t,setUserMessage:i,isChatProcessing:f,onChangeUserMessage:m}=e,g=function(){let[e,t]=(0,a.useState)(void 0),[s,i]=(0,a.useState)(!1),[o,n]=(0,a.useState)(!1),l=function(e,t){let[s]=(0,a.useState)(()=>(function(e,t){if("whisper"===e){let e=new Worker(r.tu(new URL(r.p+r.u(6217),r.b)),{type:void 0});return e.addEventListener("message",t),e}throw Error("workerType not found")})(e,t));return s}("whisper",e=>{let r=e.data;switch(r.status){case"progress":(0,c.I)(r.file,r.progress);break;case"update":t({isBusy:!0,text:r.data[0],chunks:r.data[1].chunks});break;case"complete":console.log("useTranscriber complete",r),t({isBusy:!1,text:r.data.text,chunks:r.data.chunks}),i(!1);break;case"initiate":n(!0);break;case"ready":n(!1);break;case"error":i(!1),alert("".concat(r.data.message," This is most likely because you are using Safari on an M1/M2 Mac. Please try again from Chrome, Firefox, or Edge.\n\nIf this is not the case, please file a bug report."));break;case"done":(0,c.I)(r.file,100)}}),u=(0,a.useCallback)(()=>{t(void 0)},[]),d=(0,a.useCallback)(async e=>{if(e){let r;if(t(void 0),i(!0),2===e.numberOfChannels){let t=Math.sqrt(2),s=e.getChannelData(0),i=e.getChannelData(1);r=new Float32Array(s.length);for(let a=0;a<e.length;++a)r[a]=t*(s[a]+i[a])/2}else r=e.getChannelData(0);l.postMessage({audio:r})}},[l]),h=(0,a.useMemo)(()=>({onInputChange:u,isBusy:s,isModelLoading:o,start:d,output:e}),[s,o,d,e]);return h}(),v=(0,a.useRef)(null),[w,S]=(0,a.useState)(null),[b,_]=(0,a.useState)(null),{chat:y}=(0,a.useContext)(u.p),{alert:A}=(0,a.useContext)(l.w),{amicaLife:F}=(0,a.useContext)(p.r),P=(0,o.useMicVAD)({startOnLoad:!1,onSpeechStart:()=>{console.debug("vad","on_speech_start"),console.time("performance_speech")},onSpeechEnd:e=>{console.debug("vad","on_speech_end"),console.timeEnd("performance_speech"),console.time("performance_transcribe"),window.chatvrm_latency_tracker={start:+Date.now(),active:!0};try{switch((0,d.vc)("stt_backend")){case"whisper_browser":{console.debug("whisper_browser attempt");let t=new AudioContext,r=t.createBuffer(1,e.length,16e3);r.copyToChannel(e,0,0),g.start(r);break}case"whisper_openai":{let t;console.debug("whisper_openai attempt");let r=new h.J;r.fromScratch(1,16e3,"32f",e);let s=new File([r.toBuffer()],"input.wav",{type:"audio/wav"});(async()=>{try{let e=await openaiWhisper(s,t);S(e)}catch(e){console.error("whisper_openai error",e),A.error("whisper_openai error",e.toString())}})();break}case"whispercpp":{let t;console.debug("whispercpp attempt");let r=new h.J;r.fromScratch(1,16e3,"32f",e),r.toBitDepth("16");let s=new File([r.toBuffer()],"input.wav",{type:"audio/wav"});(async()=>{try{let e=await whispercpp(s,t);_(e)}catch(e){console.error("whispercpp error",e),A.error("whispercpp error",e.toString())}})()}}}catch(e){console.error("stt_backend error",e),A.error("STT backend error",e.toString())}}});function handleTranscriptionResult(e){let t=(console.log("transcript",e),e.trim().replaceAll(/\[.+\]|{.+}|\(.+\)/gm,"").trim()),r="true"===(0,d.vc)("wake_word_enabled"),s=r&&cleanFromPunctuation(t).startsWith(cleanFromPunctuation((0,d.vc)("wake_word"))),a=r&&s?function(e,t){if(!e.toLowerCase().startsWith(t.toLowerCase()))return e;let r=t.split(" ").length,s=e.split(" ").slice(r).join(" ");return"".concat((""+s.charAt(0)).toUpperCase()).concat(s.substring(1))}(t,(0,d.vc)("wake_word")):t;r?s?("true"===(0,d.vc)("amica_life_enabled")&&F.pause(),y.updateAwake()):"true"!==(0,d.vc)("amica_life_enabled")||!0===F.triggerMessage||y.isAwake()||y.updateAwake():"true"===(0,d.vc)("amica_life_enabled")&&(F.pause(),y.updateAwake()),""!==a&&("true"===(0,d.vc)("autosend_from_mic")?(!r||y.isAwake())&&y.receiveMessageFromUser(a,!1):i(a),console.timeEnd("performance_transcribe"))}function clickedSendButton(){if(y.receiveMessageFromUser(t,!1),!P.listening){var e;null===(e=v.current)||void 0===e||e.focus()}i("")}return P.errored&&console.error("vad error",P.errored),(0,a.useEffect)(()=>{if(g.output&&!g.isBusy){var e;let t=null===(e=g.output)||void 0===e?void 0:e.text;handleTranscriptionResult(t)}},[g]),(0,a.useEffect)(()=>{if(w){let e=null==w?void 0:w.text;handleTranscriptionResult(e)}},[w]),(0,a.useEffect)(()=>{if(b){let e=null==b?void 0:b.text;handleTranscriptionResult(e)}},[b]),(0,s.jsx)("div",{className:"fixed bottom-2 z-20 w-full",children:(0,s.jsx)("div",{className:"mx-auto max-w-4xl p-2 backdrop-blur-lg border-0 rounded-lg",children:(0,s.jsxs)("div",{className:"grid grid-flow-col grid-cols-[min-content_1fr_min-content] gap-[8px]",children:[(0,s.jsx)("div",{className:"flex flex-col justify-center items-center",children:(0,s.jsx)(n.h,{iconName:P.listening?"24/PauseAlt":"24/Microphone",className:"bg-secondary hover:bg-secondary-hover active:bg-secondary-press disabled:bg-secondary-disabled",isProcessing:P.userSpeaking,disabled:"none"===(0,d.vc)("stt_backend")||P.loading||!!P.errored,onClick:P.toggle})}),(0,s.jsx)("input",{type:"text",ref:v,placeholder:"Write message here...",onChange:function(e){m(e),"true"===(0,d.vc)("amica_life_enabled")&&(F.pause(),y.updateAwake())},onKeyDown:e=>{if("Enter"===e.key){if(""===t)return!1;clickedSendButton()}},disabled:!1,className:"disabled block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-1 focus:ring-inset focus:ring-gray-400 sm:text-sm sm:leading-6",value:t}),(0,s.jsx)("div",{className:"flex flex-col justify-center items-center",children:(0,s.jsx)(n.h,{iconName:"24/Send",className:"ml-2 bg-secondary hover:bg-secondary-hover active:bg-secondary-press disabled:bg-secondary-disabled",isProcessing:f||g.isBusy,disabled:f||!t||g.isModelLoading,onClick:clickedSendButton})})]})})})}i.env.wasm.wasmPaths="/_next/static/chunks/"}}]);